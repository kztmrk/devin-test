# Streamlit OpenAI チャットボットアプリケーション設計書

## 1. 全体システムアーキテクチャ

このアプリケーションは、StreamlitフロントエンドとOpenAI APIを使用したバックエンドで構成されるシンプルなチャットボットアプリケーションです。ユーザーはローカルPCでアプリケーションを実行し、OpenAI APIを使用して会話を行います。

```
+-------------------+        +-------------------+        +-------------------+
|                   |        |                   |        |                   |
|  Streamlit UI     | <----> |  Python Backend   | <----> |  OpenAI API       |
|  (フロントエンド)  |        |  (ロジック処理)    |        |  (LLMサービス)    |
|                   |        |                   |        |                   |
+-------------------+        +-------------------+        +-------------------+
```

## 2. 主要コンポーネントとその相互作用

### 2.1 フロントエンド (Streamlit)
- ユーザーインターフェース表示
- メッセージ入力フォーム
- チャット履歴表示
- ストリーミングレスポンス表示

### 2.2 バックエンド (Python)
- OpenAI API通信処理
- メッセージ履歴管理
- ストリーミングレスポンス処理
- エラーハンドリング

### 2.3 外部サービス
- OpenAI API: チャットモデル（GPT-4, GPT-3.5-turbo等）へのアクセス

### 2.4 コンポーネント間の相互作用
1. ユーザーがStreamlit UIでメッセージを入力
2. Pythonバックエンドがメッセージを受け取り、会話履歴と共にOpenAI APIにリクエスト送信
3. OpenAI APIからのレスポンスをストリーミング形式で受信
4. ストリーミングレスポンスをリアルタイムでStreamlit UIに表示
5. 会話履歴を更新

## 3. 必要なライブラリと依存関係

### 3.1 主要ライブラリ
- **streamlit**: UIフレームワーク
- **openai**: OpenAI APIクライアント
- **python-dotenv**: 環境変数管理

### 3.2 依存関係
```
streamlit>=1.32.0
openai>=1.12.0
python-dotenv>=1.0.0
```

## 4. StreamlitフロントエンドとOpenAI API間のデータフロー

### 4.1 データフロー図
```
+----------------+     +----------------+     +----------------+     +----------------+
|                |     |                |     |                |     |                |
| ユーザー入力    | --> | メッセージ処理  | --> | OpenAI API呼出 | --> | ストリーミング |
| (Streamlit)    |     | (Python)       |     | (HTTP Request) |     | レスポンス処理  |
|                |     |                |     |                |     |                |
+----------------+     +----------------+     +----------------+     +----------------+
                                                                            |
                                                                            v
                       +----------------+     +----------------+     +----------------+
                       |                |     |                |     |                |
                       | 会話履歴更新   | <-- | UI更新         | <-- | レスポンス解析 |
                       | (Python)       |     | (Streamlit)    |     | (Python)       |
                       |                |     |                |     |                |
                       +----------------+     +----------------+     +----------------+
```

### 4.2 データ構造
- **メッセージ**: `{"role": str, "content": str}`
- **会話履歴**: `List[Dict[str, str]]`
- **ストリーミングレスポンス**: チャンク単位のテキスト

## 5. ユーザーインターフェースのレイアウトと機能

### 5.1 レイアウト
- ヘッダー: アプリケーションタイトル
- サイドバー: 設定パネル（APIキー入力、モデル選択など）
- メインエリア:
  - チャット履歴表示領域
  - メッセージ入力フォーム

### 5.2 機能
- **メッセージ送信**: テキスト入力とボタンによるメッセージ送信
- **チャット履歴表示**: ユーザーとAIのメッセージを視覚的に区別して表示
- **ストリーミング表示**: AIの応答をリアルタイムで表示
- **設定管理**: APIキー、モデル選択などの設定
- **会話リセット**: 会話履歴をクリアする機能

## 6. エラーハンドリングアプローチ

### 6.1 想定されるエラー
- API接続エラー
- 認証エラー（無効なAPIキー）
- レート制限エラー
- モデル利用不可エラー
- ストリーミング中断エラー

### 6.2 エラーハンドリング戦略
- **try-except構造**: すべてのAPI呼び出しをtry-except文で囲む
- **ユーザーフレンドリーなエラーメッセージ**: 技術的詳細を隠し、ユーザーが理解できるメッセージを表示
- **リトライメカニズム**: 一時的なエラーに対する自動リトライ
- **フォールバック応答**: APIエラー時に代替メッセージを表示
- **ログ記録**: エラー情報をログに記録（デバッグ用）

## 7. 追加考慮事項

### 7.1 メッセージ履歴管理
- **セッション状態**: Streamlitのセッション状態を使用して会話履歴を保持
- **コンテキスト管理**: トークン数制限を考慮した会話履歴の管理
- **永続化オプション**: 会話履歴の保存と読み込み機能（オプション）

### 7.2 ストリーミング実装詳細
- **SSE (Server-Sent Events)**: OpenAI APIのストリーミングレスポンスを処理
- **増分更新**: Streamlitの`empty()`コンテナを使用して応答を増分的に更新
- **タイプライターエフェクト**: 文字が徐々に表示される効果の実装

### 7.3 ユーザーエクスペリエンス設計
- **レスポンシブデザイン**: 異なる画面サイズに対応
- **視覚的フィードバック**: 処理中の状態を示すローディングインジケータ
- **メッセージスタイリング**: ユーザーとAIのメッセージを視覚的に区別
- **キーボードショートカット**: Enterキーでメッセージ送信など

### 7.4 ローカル環境セットアップ要件
- **Python環境**: Python 3.8以上
- **依存関係インストール**: pipを使用したライブラリインストール
- **環境変数**: `.env`ファイルを使用したAPIキー管理
- **実行コマンド**: `streamlit run app.py`

## 8. 実装計画

### 8.1 フェーズ1: 基本機能実装
- プロジェクト構造セットアップ
- 基本的なStreamlit UI実装
- OpenAI API連携（非ストリーミング）
- 会話履歴管理

### 8.2 フェーズ2: ストリーミング機能実装
- ストリーミングレスポンス処理
- UIのリアルタイム更新
- エラーハンドリング

### 8.3 フェーズ3: UI/UX改善
- スタイリングとレイアウト最適化
- レスポンシブデザイン
- ユーザビリティ向上

### 8.4 フェーズ4: 追加機能実装
- 設定管理
- 会話履歴の保存/読み込み
- その他の拡張機能
